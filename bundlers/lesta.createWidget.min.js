(()=>{function m(n){return n?typeof n=="object"?JSON.parse(JSON.stringify(n)):n:n??null}function v(n,t){let e=new WeakMap;function o(r){return{getPrototypeOf(s){return{target:s,instance:"Proxy"}},set(s,i,p,g){let{path:S,ref:M}=c(r,i),A=!1;return t.beforeSet(p,M,()=>{if(s[i]!=null&&typeof s[i]=="object"){if(Reflect.has(s,i)&&h(s,i),p!=null&&typeof p=="object"){let b=JSON.stringify(p);b!==JSON.stringify(s[i])&&(p=JSON.parse(b))}}else Object.is(s[i],p)&&i!=="length"&&(A=!0)},b=>{p=m(b)}),A||(p!=null&&typeof p=="object"&&!e.has(p)&&(p=a(p,S)),Reflect.set(s,i,p,g),t.set&&t.set(s,S,p,M)),!0},get(s,i,p){if(t.get){if(i===Symbol.toPrimitive)return;let{ref:g}=c(r,i);t.get(s,g)}return Reflect.get(s,i,p)},deleteProperty(s,i){return Reflect.has(s,i)?(h(s,i),Reflect.deleteProperty(s,i)):!1}}}function c(r,s){let i=[...r,s],p=i.join(".");return{path:i,ref:p}}function h(r,s){e.has(r[s])&&e.delete(r[s]);for(let i of Object.keys(r[s]))r[s][i]!=null&&typeof r[s][i]=="object"&&h(r[s],i)}function a(r,s){for(let p of Object.keys(r))r[p]!=null&&typeof r[p]=="object"&&(r[p]=a(r[p],[...s,p]));let i=new Proxy(r,o(s));return e.set(i,r),i}return a(n,[])}function u(n,t,e,o){let c=(h,a)=>{let r=h.split("."),s=a.split(".");for(let i=0;i<s.length;i++)if(r[i]!==s[i])return!1;return!0};for(let[h,a]of n)if(Array.isArray(a))a.includes(t)&&h(e);else if(c(t,a)){let r=[...o];r.shift(),h(e,r)}}function f(n){function t(){return new DOMParser().parseFromString(n,"text/html").body||document.createElement("body")}function e(r){let s=r.querySelectorAll("script");for(let i of s)i.remove()}function o(r,s){let i=s.replace(/\s+/g,"").toLowerCase();if(["src","href","xlink:href"].includes(r)&&(i.includes("javascript:")||i.includes("data:text/html"))||r.startsWith("on"))return!0}function c(r){let s=r.attributes;for(let{name:i,value:p}of s)o(i,p)&&r.removeAttribute(i)}function h(r){let s=r.children;for(let i of s)c(i),h(i)}let a=t();return e(a),h(a),a.childNodes}async function j(n,t,e){await n.loaded(t),e&&await n.props(e,t),n.params(),n.methods(t),n.proxies(),await n.created(),await n.nodes(t),await n.mounted()}var O={update:(n,t)=>{let e=typeof t=="function"?t(n):t;n.innerHTML="",n.append(...f(e))}};var L={update:(n,t)=>{let e=typeof t=="function"?t(n):t;n.innerHTML=e}};var C={update:(n,t,e)=>{(typeof t[e]=="function"?t[e](n):t[e])?n.classList.add(e):n.classList.remove(e)}};var x=class{constructor(t,e,o){this.Nodes=o,this.component=t,this.app=e,this.proxiesData={},this.impress={refs:[],collect:!1,exclude(c){this.collect=!1;let h=c();return this.collect=!0,h},define(c){return c&&c[0]==="_"?this.refs[0]:[...this.refs]},clear(){this.collect=!1,this.refs.length=0}},this.context={exclude:this.impress.exclude.bind(this.impress),container:null,options:t,node:{},param:{},method:{},proxy:{},source:t.sources,directives:{_html:O,_evalHTML:L,_class:C},router:e.router||{},component:e.components||{},root:e.root},Object.preventExtensions(this.context.source),Object.assign(this.context,e.common||{}),Object.assign(this.context.directives,t.directives||{},e.directives||{})}async loaded(t){this.context.container=t,this.component.loaded&&await this.component.loaded.bind(this.context)()}async created(){this.component.created&&await this.component.created.bind(this.context)()}async mounted(){this.component.mounted&&await this.component.mounted.bind(this.context)()}methods(t){if(t.method||(t.method={}),this.component.methods)for(let[e,o]of Object.entries(this.component.methods))this.context.method[e]=o.bind(this.context),t.method[e]=(...c)=>this.context.method[e](...m(c));Object.preventExtensions(this.context.method)}params(){if(this.component.params)for(let t in this.component.params){if(t in this.context.param)return this.app.errorComponent(container.nodepath,213,t);this.context.param[t]=this.component.params[t]}Object.preventExtensions(this.context.param)}proxies(){if(this.component.proxies)for(let t in this.component.proxies){if(t in this.proxiesData)return this.app.errorComponent(container.nodepath,214,t);this.proxiesData[t]=this.component.proxies[t]}this.context.proxy=v(this.proxiesData,{beforeSet:(t,e,o,c)=>{if(!this.component.setters||!this.component.setters[e])o();else{let h=this.component.setters[e].bind(this.context)(t);c(h)}},set:(t,e,o,c)=>{for(let h in this.context.node){let a=this.context.node[h];a.reactivity.node&&u(a.reactivity.node,c),a.reactivity.component&&u(a.reactivity.component,c,o,e);for(let r in a.section)a.section[r]?.reactivity.component&&u(a.section[r].reactivity.component,c,o,e)}this.component.handlers&&this.component.handlers[c]?.bind(this.context)(o)},get:(t,e)=>{this.impress.collect&&!this.impress.refs.includes(e)&&this.impress.refs.push(e)}}),Object.preventExtensions(this.context.proxy)}async nodes(t){if(this.component.nodes){let e=this.component.nodes.bind(this.context)();for await(let[o,c]of Object.entries(e)){let h=this.component.selectors&&this.component.selectors[o]||`.${o}`,a=t.querySelector(h)||t.classList.contains(o)&&t;if(!a)return this.app.errorNode(o,105);if(a.nodepath=t.nodepath?t.nodepath+"."+o:o,a.nodename=o,Object.assign(this.context.node,{[o]:a}),c){let r=new this.Nodes(c,this.context,a,this.impress,this.app,o);for await(let[s]of Object.entries(c))await r.controller(s)}}Object.preventExtensions(this.context.node)}}};var I={102:'incorrect directive name "%s", the name must start with the character "_".',103:'node property "%s" expects an object as its value.',104:'unknown node property: "%s".',105:"node with this name was not found in the template.",106:"innerHTML method is not secure due to XXS attacks, use _html or _evalHTML directives."},P=(n,t,e="")=>console.error(`[Lesta error ${t}]: Error in node "${n}": ${I[t]}`,e);var l=class{constructor(t,e,o,c,h,a){this.app=h,this.node=t,this.context=e,this.impress=c,this.nodeElement=o,this.keyNode=a,this.nodeElement.reactivity={node:new Map}}reactive(t,e,o){t.length&&o.set(e,t),this.impress.clear()}reactiveNode(t,e){this.reactive(t,e,this.nodeElement.reactivity.node)}};var y=class extends l{constructor(...t){super(...t)}init(t){if(t[0]!=="_")return this.app.errorNode(this.nodeElement.nodepath,102,t);let e=this.context.directives[t],o=this.node[t],{create:c,update:h,destroy:a}=e;"directives"in this.nodeElement||Object.assign(this.nodeElement,{directives:{}}),Object.assign(this.nodeElement.directives,{[t]:{create:()=>c?c(this.nodeElement,o,e):{},destroy:()=>a?a(this.nodeElement,o,e):{}}}),c&&this.nodeElement.directives[t].create();let r=(s,i,p)=>{typeof s=="function"?(this.impress.collect=!0,h.bind(e)(this.nodeElement,i,p),this.reactiveNode(this.impress.define(),()=>h(this.nodeElement,i,p))):h.bind(e)(this.nodeElement,i,p)};if(h!=null)if(typeof o=="object")for(let s in o)r(o[s],o,s);else r(o,o)}};var w=class extends l{constructor(...t){super(...t)}listeners(t){typeof this.node[t]=="function"&&(this.nodeElement[t]=e=>this.node[t].bind(this.context)(e))}general(t){if(t==="innerHTML")return this.app.errorNode(this.nodeElement.nodepath,106);if(typeof this.node[t]=="function"){let e=()=>{let o=this.node[t].bind(this.context)(this.nodeElement);this.nodeElement[t]!==null&&typeof this.nodeElement[t]=="object"?o!==null&&typeof o=="object"?Object.assign(this.nodeElement[t],o):this.app.errorNode(this.nodeElement.nodepath,103,t):this.nodeElement[t]=o!==Object(o)?o:JSON.stringify(o)};this.impress.collect=!0,e(),this.reactiveNode(this.impress.define(),e)}else this.nodeElement[t]=this.node[t]}init(t){t.substr(0,2)==="on"?this.listeners(t):this.general(t)}};var d=class{constructor(t,e,o,c,h,a){this.app=h,this.node=t,this.context=e,this.impress=c,this.nodeElement=o,this.keyNode=a,this.directive=new y(t,e,o,c,h,a),this.native=new w(t,e,o,c,h,a)}async controller(t){t in this.nodeElement?this.native.init(t):t in this.context.directives?this.directive.init(t):t==="component"&&this.component?await this.component():this.app.errorNode(this.nodeElement.nodepath,104,t)}};async function N(n,t){let e=new x(n,{errorNode:P},d);return t.append(...f(n.template)),await j(e,t),{destroy(){t.reactivity&&t.reactivity.node.clear(),t.method={},t.innerHTML=""}}}window.lesta={createWidget:N};})();
