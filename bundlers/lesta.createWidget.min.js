(()=>{function u(i){return i?typeof i=="object"?JSON.parse(JSON.stringify(i)):i:i??null}function v(i,t){let e=new WeakMap;function o(n){return{getPrototypeOf(s){return{target:s,instance:"Proxy"}},set(s,a,p,g){let{path:M,ref:A}=c(n,a),w=!1;return t.beforeSet(p,A,()=>{if(s[a]!=null&&typeof s[a]=="object"){if(s[a]===p&&(w=!0),Reflect.has(s,a)&&h(s,a),p!=null&&typeof p=="object"){let b=JSON.stringify(p);b!==JSON.stringify(s[a])?p=JSON.parse(b):w=!0}}else Object.is(s[a],p)&&a!=="length"&&(w=!0)},b=>{p=u(b)}),w||(p!=null&&typeof p=="object"&&!e.has(p)&&(p=r(p,M)),Reflect.set(s,a,p,g),t.set&&t.set(s,M,p,A)),!0},get(s,a,p){if(t.get){if(a===Symbol.toPrimitive)return;let{ref:g}=c(n,a);t.get(s,g)}return Reflect.get(s,a,p)},deleteProperty(s,a){return Reflect.has(s,a)?(h(s,a),Reflect.deleteProperty(s,a)):!1}}}function c(n,s){let a=[...n,s],p=a.join(".");return{path:a,ref:p}}function h(n,s){e.has(n[s])&&e.delete(n[s]);for(let a of Object.keys(n[s]))n[s][a]!=null&&typeof n[s][a]=="object"&&h(n[s],a)}function r(n,s){for(let p of Object.keys(n))n[p]!=null&&typeof n[p]=="object"&&(n[p]=r(n[p],[...s,p]));let a=new Proxy(n,o(s));return e.set(a,n),a}return r(i,[])}function f(i,t,e,o){let c=(h,r)=>{let n=h.split("."),s=r.split(".");for(let a=0;a<s.length;a++)if(n[a]!==s[a])return!1;return!0};for(let[h,r]of i)if(Array.isArray(r))r.includes(t)&&h(e);else if(c(t,r)){let n=[...o];n.shift(),h(e,n)}}function E(i){return new DOMParser().parseFromString(i,"text/html").body||document.createElement("body")}function O(i){function t(r){let n=r.querySelectorAll("script");for(let s of n)s.remove()}function e(r,n){let s=n.replace(/\s+/g,"").toLowerCase();if(["src","href","xlink:href"].includes(r)&&(s.includes("javascript:")||s.includes("data:text/html"))||r.startsWith("on"))return!0}function o(r){let n=r.attributes;for(let{name:s,value:a}of n)e(s,a)&&r.removeAttribute(s)}function c(r){let n=r.children;for(let s of n)o(s),c(s)}let h=E(i);return t(h),c(h),h.childNodes}async function L(i,t,e){await i.loaded(t),e&&await i.props(e,t),i.params(),i.methods(t),i.proxies(),await i.created(),await i.nodes(t),await i.mounted()}var P={update:(i,t)=>{let e=typeof t=="function"?t(i):t;i.innerHTML="",i.append(...O(e))}};var C={update:(i,t)=>{let e=typeof t=="function"?t(i):t;i.innerHTML=e}};var S={update:(i,t,e)=>{(typeof t[e]=="function"?t[e](i):t[e])?i.classList.add(e):i.classList.remove(e)}};var d=class{constructor(t,e,o){this.Nodes=o,this.component=t,this.app=e,this.proxiesData={},this.impress={refs:[],collect:!1,exclude(c){this.collect=!1;let h=c();return this.collect=!0,h},define(c){return c&&c.startsWith("_")?this.refs[0]:[...this.refs]},clear(){this.collect=!1,this.refs.length=0}},this.context={exclude:this.impress.exclude.bind(this.impress),container:null,options:t,node:{},param:{},method:{},proxy:{},source:t.sources,directives:{_html:P,_evalHTML:C,_class:S},router:e.router||{},component:e.components||{},root:e.root},Object.preventExtensions(this.context.source),Object.assign(this.context,e.common||{}),Object.assign(this.context.directives,t.directives||{},e.directives||{})}async loaded(t){this.context.container=t,this.component.loaded&&await this.component.loaded.bind(this.context)()}async created(){this.component.created&&await this.component.created.bind(this.context)()}async mounted(){this.component.mounted&&await this.component.mounted.bind(this.context)()}methods(t){if(t.method||(t.method={}),this.component.methods)for(let[e,o]of Object.entries(this.component.methods))this.context.method[e]=o.bind(this.context),t.method[e]=(...c)=>this.context.method[e](...u(c));Object.preventExtensions(this.context.method)}params(){if(this.component.params)for(let t in this.component.params){if(t in this.context.param)return this.app.errorComponent(container.nodepath,213,t);this.context.param[t]=this.component.params[t]}Object.preventExtensions(this.context.param)}proxies(){if(this.component.proxies)for(let t in this.component.proxies){if(t in this.proxiesData)return this.app.errorComponent(container.nodepath,214,t);this.proxiesData[t]=this.component.proxies[t]}this.context.proxy=v(this.proxiesData,{beforeSet:(t,e,o,c)=>{if(!this.component.setters||!this.component.setters[e])o();else{let h=this.component.setters[e].bind(this.context)(t);c(h)}},set:(t,e,o,c)=>{for(let h in this.context.node){let r=this.context.node[h];r.reactivity.node&&f(r.reactivity.node,c),r.reactivity.component&&f(r.reactivity.component,c,o,e);for(let n in r.section)r.section[n]?.reactivity.component&&f(r.section[n].reactivity.component,c,o,e)}this.component.handlers&&this.component.handlers[c]?.bind(this.context)(o)},get:(t,e)=>{this.impress.collect&&!this.impress.refs.includes(e)&&this.impress.refs.push(e)}}),Object.preventExtensions(this.context.proxy)}async nodes(t){if(this.component.nodes){let e=this.component.nodes.bind(this.context)();for await(let[o,c]of Object.entries(e)){let h=this.component.selectors&&this.component.selectors[o]||`.${o}`,r=t.querySelector(h)||t.classList.contains(o)&&t;if(!r)return this.app.errorNode(o,105);if(r.nodepath=t.nodepath?t.nodepath+"."+o:o,r.nodename=o,Object.assign(this.context.node,{[o]:r}),c){let n=new this.Nodes(c,this.context,r,this.impress,this.app,o);for await(let[s]of Object.entries(c))await n.controller(s)}}Object.preventExtensions(this.context.node)}}};var z={102:'incorrect directive name "%s", the name must start with the character "_".',103:'node property "%s" expects an object as its value.',104:'unknown node property: "%s".',105:"node with this name was not found in the template.",106:"innerHTML method is not secure due to XXS attacks, use _html or _evalHTML directives."},T=(i,t,e="")=>console.error(`[Lesta error ${t}]: Error in node "${i}": ${z[t]}`,e);var m=class{constructor(t,e,o,c,h,r){this.app=h,this.node=t,this.context=e,this.impress=c,this.nodeElement=o,this.keyNode=r,this.nodeElement.reactivity={node:new Map}}reactive(t,e,o){t.length&&o.set(e,t),this.impress.clear()}reactiveNode(t,e){this.reactive(t,e,this.nodeElement.reactivity.node)}};var x=class extends m{constructor(...t){super(...t)}init(t){if(t[0]!=="_")return this.app.errorNode(this.nodeElement.nodepath,102,t);let e=this.context.directives[t],o=this.node[t],{create:c,update:h,destroy:r}=e;"directives"in this.nodeElement||Object.assign(this.nodeElement,{directives:{}}),Object.assign(this.nodeElement.directives,{[t]:{create:()=>c?c(this.nodeElement,o,e):{},destroy:()=>r?r(this.nodeElement,o,e):{}}}),c&&this.nodeElement.directives[t].create();let n=(s,a,p)=>{typeof s=="function"?(this.impress.collect=!0,h.bind(e)(this.nodeElement,a,p),this.reactiveNode(this.impress.define(),()=>h(this.nodeElement,a,p))):h.bind(e)(this.nodeElement,a,p)};if(h!=null)if(typeof o=="object")for(let s in o)n(o[s],o,s);else n(o,o)}};var y=class extends m{constructor(...t){super(...t)}listeners(t){typeof this.node[t]=="function"&&(this.nodeElement[t]=e=>this.node[t].bind(this.context)(e))}general(t){if(t==="innerHTML")return this.app.errorNode(this.nodeElement.nodepath,106);if(typeof this.node[t]=="function"){let e=()=>{let o=this.node[t].bind(this.context)(this.nodeElement);this.nodeElement[t]!==null&&typeof this.nodeElement[t]=="object"?o!==null&&typeof o=="object"?Object.assign(this.nodeElement[t],o):this.app.errorNode(this.nodeElement.nodepath,103,t):this.nodeElement[t]=o!==Object(o)?o:JSON.stringify(o)};this.impress.collect=!0,e(),this.reactiveNode(this.impress.define(),e)}else this.nodeElement[t]=this.node[t]}init(t){t.substr(0,2)==="on"?this.listeners(t):this.general(t)}};var l=class{constructor(t,e,o,c,h,r){this.app=h,this.node=t,this.context=e,this.impress=c,this.nodeElement=o,this.keyNode=r,this.directive=new x(t,e,o,c,h,r),this.native=new y(t,e,o,c,h,r)}async controller(t){t in this.nodeElement?this.native.init(t):t in this.context.directives?this.directive.init(t):t==="component"&&this.component?await this.component():this.app.errorNode(this.nodeElement.nodepath,104,t)}};async function N(i,t){let e=new d(i,{errorNode:T},l);return t.innerHTML=i.template,await L(e,t),{destroy(){t.reactivity&&t.reactivity.node.clear(),t.method={},t.innerHTML=""}}}window.lesta={createWidget:N};})();
